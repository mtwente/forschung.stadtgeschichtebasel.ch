<!-- load DataTables with jquery bundled -->
<script
  type="text/javascript"
  language="javascript"
  src="{{ '/assets/lib/datatables/datatables.min.js' | relative_url }}"
></script>

<script>
$(document).ready(function() {
    const bibUrl = 'https://raw.githubusercontent.com/Stadt-Geschichte-Basel/zotero-bib-to-gh/master/bibliography/2256884.bib';

    // Function to parse the .bib file content
    function parseBibtex(bibtex) {
        const entries = [];
        const entryRegex = /@(\w+){([^,]+),([\s\S]+?)\n}\n/g;
        let match;
        while ((match = entryRegex.exec(bibtex)) !== null) {
            const entryType = match[1];
            const entryKey = match[2];
            const fields = {};
            const fieldRegex = /(\w+)\s*=\s*{([^}]+)}/g;
            let fieldMatch;
            while ((fieldMatch = fieldRegex.exec(match[3])) !== null) {
                fields[fieldMatch[1].toLowerCase()] = fieldMatch[2];
            }
            entries.push({
                entryType: entryType,
                entryKey: entryKey,
                ...fields
            });
        }
        return entries;
    }

    // Fetch and parse the .bib file
    fetch(bibUrl)
        .then(response => response.text())
        .then(data => {
            const parsedEntries = parseBibtex(data);

            // Initialize DataTable
            $('#zotero-table').DataTable({
                data: parsedEntries,
                columns: [
                    { data: 'title', title: 'Title' },
                    { data: 'author', title: 'Author' },
                    { data: 'date', title: 'Date' },
                    { data: 'entryType', title: 'Type' },
                    //{
                    //    data: 'entryKey',
                    //    title: 'Link',
                    //    render: function(data) {
                    //        return `<a href="https://doi.org/${data}" target="_blank">View</a>`;
                    //    }
                    //}
                ],
                paging: true,
                lengthMenu: [[25, 50, 100, -1], [25, 50, 100, "âˆž"]],
                dom: 'B<"row mt-2"<"col-md-6"l><"col-md-6"f>>t<"row"<"col-md-6"i><"col-md-6"p>>',
                buttons: [
                    {
                        extend: 'collection',
                        text: 'Export',
                        className: 'btn btn-outline-primary',
                        buttons: [
                            { text: 'Excel', extend: 'excelHtml5', className: 'btn btn-outline-primary' },
                            { text: 'CSV', extend: 'csvHtml5', className: 'btn btn-outline-primary' }
                        ]
                    }
                ],
                order: [[2, 'desc']]
            });
        })
        .catch(error => console.error('Error fetching or parsing .bib file:', error));
});
</script>
